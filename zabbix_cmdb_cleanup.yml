---
- name: Cleanup Zabbix hosts with tag cmdb=true not in AWX inventory
  hosts: localhost
  gather_facts: false

  vars:
    zabbix_api_url: "{{ lookup('env', 'ZABBIX_API_URL') }}"
    zabbix_api_token: "{{ lookup('env', 'ZABBIX_API_TOKEN') }}"
    awx_inventory_hostnames: "{{ groups['all'] | default([]) }}"
    dry_run: true  # Set to false to actually delete hosts

  tasks:
    - name: Get all Zabbix hosts with tags
      uri:
        url: "{{ zabbix_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        validate_certs: false
        body:
          jsonrpc: "2.0"
          method: "host.get"
          params:
            output: ["hostid", "host"]
            selectTags: "extend"
          auth: "{{ zabbix_api_token }}"
          id: 1
      register: all_zabbix_hosts
      delegate_to: localhost

    - name: Filter Zabbix hosts with tag cmdb=true
      set_fact:
        zabbix_cmdb_hosts: >-
          {{
            all_zabbix_hosts.json.result
            | selectattr('tags', 'defined')
            | selectattr('tags', 'select', 'cmdb_true(tags)')
            | list
          }}
      vars:
        # Helper filter: returns True if tags contain {'tag': 'cmdb', 'value': 'true'}
        cmdb_true: |
          {% filter from_yaml %}
          !!python/name:__main__.cmdb_true
          {% endfilter %}
      # Below is not supported in vanilla Ansible/Jinja2; define inline below

    - name: Workaround filter to select hosts with cmdb=true (Jinja2 can't do complex logic inline)
      set_fact:
        zabbix_cmdb_hosts: >-
          {{
            all_zabbix_hosts.json.result
            | selectattr('tags', 'defined')
            | selectattr('tags', 'truthy', 'is_cmdb_true')
            | list
          }}
      vars:
        # We need to define the helper here (dirty hack since Jinja can't do this inline!)
        is_cmdb_true: |
          {% macro is_cmdb_true(tags) -%}
          {%- for tag in tags -%}
            {%- if tag.tag == "cmdb" and tag.value == "true" -%}
              {{ True }}
            {%- endif -%}
          {%- endfor -%}
          {{ False }}
          {%- endmacro %}
      no_log: false

    - name: Extract orphaned hosts (in Zabbix but not in AWX)
      set_fact:
        orphaned_hosts: >-
          {{
            zabbix_cmdb_hosts
            | rejectattr('host', 'in', awx_inventory_hostnames)
            | list
          }}

    - name: Show orphaned hosts that would be removed
      debug:
        msg: "Dry Run - would remove Zabbix host '{{ item.host }}' (ID {{ item.hostid }})"
      loop: "{{ orphaned_hosts }}"
      when: dry_run | bool

    - name: Delete orphaned Zabbix hosts with cmdb=true (force delete)
      uri:
        url: "{{ zabbix_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "host.delete"
          params: "{{ orphaned_hosts | map(attribute='hostid') | list }}"
          auth: "{{ zabbix_api_token }}"
          id: 2
        status_code: [200]
        validate_certs: false
      when: not dry_run | bool and orphaned_hosts | length > 0
